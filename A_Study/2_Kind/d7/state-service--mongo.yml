# B: ---------------------------------
# 1. PersistentVolume
# ------------------------------------

kind: PersistentVolume
apiVersion: v1
metadata: 
  name: pv-vol-1--mongodb #G:1
  # labels:
  #   app:
  # namespace: node-app-1 #R: NO NEEDED |===| â­â­â­â­â­
spec:
  # storageClassName: pv-vol-1 R: not needed for VolumeName Bindign   â­â­â­â­â­
  # volumeName:  ""  ðŸŸ¥
  capacity:
    storage: 1Gi
  hostPath:
    path: /home/mukuldk/k8s-storage/pv-vol-1/
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
--- 

# B: ---------------------------------
# 2. PersistentVolumeClaim
# ------------------------------------
# https://kubernetes.io/docs/concepts/storage/persistent-volumes/

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-vol-1--mongodb   # G: 2
  namespace: node-app-1
  labels:
    app: pvc-vol-1
spec:
  # AKS: default,managed-premium
  # GKE: standard
  # EKS: gp2 (custom)
  # Rook: rook-ceph-block,rook-ceph-fs
  storageClassName: "" # ðŸŸ¥
  volumeName: pv-vol-1--mongodb # Y: |G=>1| ðŸŸ¥
  accessModes:
  - ReadWriteOnce 
  resources:
    requests:
      storage: 1Gi
---
# B: ---------------------------------
# 3. StatefulSet
# ------------------------------------
# https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: stateful--podtemp--mongocont
  namespace: node-app-1
spec:
  replicas: 1 # by default is 1
  # R: Limitations: IF WE HAVE TO REPLICATE THE POD + WE NEED VolumeClaimTemplete insted of 2.pvc   ðŸ”¯ðŸ”¯ðŸ”¯ðŸ”¯ðŸ”¯
  serviceName: "service--mongocont"  # Y: |G=>5|
  selector:
    matchLabels:
      app: podtemp--mongocont  # Y: |G=>4|
  template:
    metadata:
      # annotations:
      #   kubectl.kubernetes.io/default-container:  mongocont
      labels:
        app: podtemp--mongocont # G: 4
    spec:
      securityContext:
        runAsUser: 1000          # your host UID
        runAsGroup: 1000         # your host GID  
        fsGroup: 1000            # â† THIS makes the volume chownâ€™d to 1000:1000
      # terminationGracePeriodSeconds: 10
      containers:
      - name: mongocont
        # image: mongo:6.0.5
        image: mongo:4.4
        ports:
        - containerPort: 27017
          name: mongo
        # env:
        # command:
        # args:
        volumeMounts:
        - name: mongo-volume  # Y: |G=>3|
          mountPath: /data/db
      volumes:
        - name: mongo-volume # G: 3
          persistentVolumeClaim:
            claimName: pvc-vol-1--mongodb  # Y: |G=>2|

---

# B: ---------------------------------
# 4. Service
# ------------------------------------
# https://kubernetes.io/docs/concepts/services-networking/service/

apiVersion: v1
kind: Service
metadata:
  name: service--mongocont # G: 5
  namespace: node-app-1
spec:
  clusterIP: None # R: VERY IMPORTANT â€“ makes it a *Headless Service* Allows each pod to have its own DNS like: mongo-0.mongo-service.node-app-1.svc.cluster.local
  selector:
    app: podtemp--mongocont  # Y: |G=>4|
  # type: 
  ports:
  - name: mongodb
    protocol: TCP
    port: 27017
    targetPort: 27017
    # nodePort: 30001
---

#IMP: Once deployed, your NodeJS backend can connect to Mongo via the service DNS: mongodb://service--mongocont.node-app-1.svc.cluster.local:27017/your-db-name 
#(adjust as needed; add auth env vars to the StatefulSet if using credentials).
