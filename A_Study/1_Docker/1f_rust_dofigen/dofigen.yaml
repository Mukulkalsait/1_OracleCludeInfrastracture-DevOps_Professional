
  muslrust:
    fromImage: clux/muslrust:stable
    workdir: /app
    bind:
      - Cargo.toml
      - Cargo.lock
      - src/
    run:
      # Build with musl to work with scratch
      - cargo build --release
      # copy the generated binary outside of the target directory. If not the other stages won't be able to find it since it's in a cache volume
      - mv target/x86_64-unknown-linux-musl/release/chapter_1 /tmp/
      # - mv target/x86_64-unknown-linux-musl/release/${CARGO_PKG_NAME} /tmp/
    cache:
      # Cargo cache
      - /home/rust/.cargo
      # build cache
      - /app/target

# Runtime
workdir: /app
copy:
  - fromBuilder: muslrust
    paths: "/tmp/chapter_1"
    target: "/bin/"
entrypoint: chapter_1
cmd: --help
context:
  - "/src"
  - "/Cargo.*"
